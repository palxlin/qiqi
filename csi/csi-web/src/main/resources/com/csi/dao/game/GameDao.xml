<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.csi.dao.game.IGameDao">
    <insert id="createGame" parameterType="com.csi.model.game.Game">
        insert into tbl_current_game
        (
        game_no,
        game_type,
        create_user,
        nums,
        pos_of_crime_user,
        pos_of_crime_ass_user,
        pos_of_witness_user,
        status,
        remark
        )
        VALUES
        (
        #{game.gameNo, jdbcType=INTEGER},
        #{game.gameType, jdbcType=VARCHAR},
        #{game.createUser, jdbcType=VARCHAR},
        #{game.nums, jdbcType=INTEGER},
        #{game.posOfCrimeUser, jdbcType=INTEGER},
        #{game.posOfCrimeUserAss, jdbcType=INTEGER},
        #{game.posOfWitness, jdbcType=INTEGER},
        #{game.status, jdbcType=INTEGER},
        #{game.remark, jdbcType=VARCHAR}
        )
    </insert>
    <insert id="createGameDetail" parameterType="com.csi.model.game.GameDetail">
        insert into tbl_current_game_detail
        (game_no,
        cause_of_death, location_of_crime,
        cause_of_death_content, location_of_crime_content,
        clue_1, clue_2, clue_3, clue_4,
        clue_1_content, clue_2_content, clue_3_content, clue_4_content,
        clue_1_title, clue_2_title, clue_3_title, clue_4_title,
        status, remark)
        VALUES
        (#{gameDetail.gameNo, jdbcType=INTEGER},
        #{gameDetail.causeOfDeath, jdbcType=INTEGER},
        #{gameDetail.locationOfCrime, jdbcType=INTEGER},
        #{gameDetail.causeOfDeathContent, jdbcType=VARCHAR},
        #{gameDetail.locationOfCrimeContent, jdbcType=VARCHAR},
        #{gameDetail.clue1, jdbcType=INTEGER},
        #{gameDetail.clue2, jdbcType=INTEGER},
        #{gameDetail.clue3, jdbcType=INTEGER},
        #{gameDetail.clue4, jdbcType=INTEGER},
        #{gameDetail.clue1Content, jdbcType=VARCHAR},
        #{gameDetail.clue2Content, jdbcType=VARCHAR},
        #{gameDetail.clue3Content, jdbcType=VARCHAR},
        #{gameDetail.clue4Content, jdbcType=VARCHAR},
        #{gameDetail.clue1Title, jdbcType=VARCHAR},
        #{gameDetail.clue2Title, jdbcType=VARCHAR},
        #{gameDetail.clue3Title, jdbcType=VARCHAR},
        #{gameDetail.clue4Title, jdbcType=VARCHAR},
        #{gameDetail.status, jdbcType=INTEGER},
        #{gameDetail.remark, jdbcType=VARCHAR})
    </insert>

    <resultMap id="crimeSceneList" type="com.csi.model.game.CrimeScene" autoMapping="true"/>
    <select id="selectCardCrimeScene" resultMap="crimeSceneList">
        select item_no as itemNo, item_type as itemType, content, pic, status, remark
        from tbl_card_crime_scene WHERE item_type = #{itemType} and status = 0;
    </select>
    <select id="selectAllCardCrimeScene" resultMap="crimeSceneList">
        select item_no as itemNo, item_type as itemType, content, pic, status, remark
        from tbl_card_crime_scene WHERE status = 0;
    </select>

    <resultMap id="itemNoList" type="Integer" autoMapping="true"/>

    <select id="selectItemNosWitnessClues" resultMap="itemNoList">
        select item_no from tbl_card_crime_scene WHERE item_type = 3 and status = 0;
    </select>

    <update id="crime">
        update tbl_current_game_detail
        set crime_item = #{crimeItemPos}, crime_clue= #{crimeCluePos},
            crime_item_name = (select crime_item_${crimeItemPos}_name from tbl_current_player where user_no = #{crimeUserNo}),
            crime_clue_name = (select crime_clue_${crimeCluePos}_name from tbl_current_player where user_no = #{crimeUserNo})
        where game_no = (select game_no from tbl_current_player where user_no = #{crimeUserNo})
    </update>

    <update id="witness">
        update tbl_current_game_detail
        set witness_chosen_cause_of_death_pos = #{witness.causePos},
            witness_chosen_location_of_crime_pos = #{witness.locationPos},
            witness_chosen_1_pos = #{witness.clue1Pos},
            witness_chosen_2_pos = #{witness.clue2Pos},
            witness_chosen_3_pos = #{witness.clue3Pos},
            witness_chosen_4_pos = #{witness.clue4Pos},
            witness_chosen_cause_of_death_name = split_str(cause_of_death_content, ',', #{witness.causePos}),
            witness_chosen_location_of_crime_name = split_str(location_of_crime_content, ',', #{witness.locationPos}),
            witness_chosen_1_name = split_str(clue_1_content, ',', #{witness.clue1Pos}),
            witness_chosen_2_name = split_str(clue_2_content, ',', #{witness.clue2Pos}),
            witness_chosen_3_name = split_str(clue_3_content, ',', #{witness.clue3Pos}),
            witness_chosen_4_name = split_str(clue_4_content, ',', #{witness.clue4Pos}),
            witness_chosen_cause_of_death_weight = substring(#{witness.weight}, 1, 1),
            witness_chosen_location_of_crime_weight = substring(#{witness.weight}, 2, 1),
            witness_chosen_1_weight = substring(#{witness.weight}, 3, 1),
            witness_chosen_2_weight = substring(#{witness.weight}, 4, 1),
            witness_chosen_3_weight = substring(#{witness.weight}, 5, 1),
            witness_chosen_4_weight = substring(#{witness.weight}, 6, 1),
            witness_chosen_weight = #{witness.weight}
        where game_no = (select game_no from tbl_current_player where user_no = #{witnessUserNo})
    </update>

    <update id="succUpdateGame">
        update tbl_current_game
        set status = 901
        where game_no = (select game_no from tbl_current_player where user_no = #{userno} and status != 99)
    </update>
    <update id="succUpdateGameDetail">
        update tbl_current_game_detail
        set status = 901
        where game_no = (select game_no from tbl_current_player where user_no = #{userno} and status != 99)
    </update>
    <update id="updateGamePlayer">
        update tbl_current_player
        set status = #{gamePlayerStatus}
        <if test="crimeVo != null">
            , detect_crime_pos = #{crimeVo.crimePos, jdbcType=INTEGER}
            , detect_crime_item_pos = #{crimeVo.crimeItemPos, jdbcType=INTEGER}
            , detect_crime_clue_pos = #{crimeVo.crimeCluePos, jdbcType=INTEGER}
        </if>
        where user_no = #{userno}) and status != 99
    </update>

    <update id="updateGameStatus">
        update tbl_current_game
        set status = #{gameStatusNew}
        where game_no = #{gameNo}
        <if test="gameStatusCondition != null">
            and status = #{gameStatusCondition}
        </if>
    </update>

    <update id="updateGameStatusByUserNo">
        update tbl_current_game
        set status = #{gameStatusNew}
        where game_no = (select game_no from tbl_current_player where status = 0 and user_no = #{userNo})
        <if test="gameStatusCondition != null">
            and status = #{gameStatusCondition}
        </if>
    </update>

    <update id="detectiveFail">
        update tbl_current_player
        set status = #{detectiveStatus}
        where user_no = #{userNo}
        and status = #{detectiveStatusOld}
    </update>

    <select id="selectCrime" resultMap="killer">
        select a.pos_of_crime_user as crimePos, b.crime_item as crimeItemPos, b.crime_clue as crimeCluePos from
        ( select * from tbl_current_game
          where game_no = (select game_no from tbl_current_player WHERE user_no = #{userno} and status != 99) ) a
        join
        (select * from tbl_current_game_detail where status != 99 ) b on a.game_no = b.game_no
    </select>
    <resultMap id="killer" type="com.csi.model.game.CrimeVo" autoMapping="true"/>

    <select id="selectCountGameByNo" resultType="int">
        select count(*) from tbl_current_game where game_no = #{gameNo} and status != 99
    </select>
    <insert id="joinGame" parameterType="com.csi.model.game.PlayerVo">
        insert into tbl_current_player
        (user_no, game_no, game_role, game_pos, status,
        crime_item_1, crime_item_2, crime_item_3, crime_item_4,
        crime_clue_1, crime_clue_2, crime_clue_3, crime_clue_4,
        crime_item_1_name, crime_item_2_name, crime_item_3_name, crime_item_4_name,
        crime_clue_1_name, crime_clue_2_name, crime_clue_3_name, crime_clue_4_name,
        crime_item_1_pic_url, crime_item_2_pic_url, crime_item_3_pic_url, crime_item_4_pic_url,
        crime_clue_1_pic_url, crime_clue_2_pic_url, crime_clue_3_pic_url, crime_clue_4_pic_url,
        remark)
        VALUES
        (#{player.userNo, jdbcType=VARCHAR},
        #{player.gameNo, jdbcType=INTEGER},
        #{player.gameRole, jdbcType=INTEGER},
        #{player.gamePos, jdbcType=INTEGER},
		#{player.status, jdbcType=INTEGER},
		#{player.crimeItem1, jdbcType=INTEGER},
		#{player.crimeItem2, jdbcType=INTEGER},
		#{player.crimeItem3, jdbcType=INTEGER},
		#{player.crimeItem4, jdbcType=INTEGER},
		#{player.crimeClue1, jdbcType=INTEGER},
		#{player.crimeClue2, jdbcType=INTEGER},
		#{player.crimeClue3, jdbcType=INTEGER},
		#{player.crimeClue4, jdbcType=INTEGER},
	    #{player.crimeItem1Name, jdbcType=VARCHAR},
        #{player.crimeItem2Name, jdbcType=VARCHAR},
        #{player.crimeItem3Name, jdbcType=VARCHAR},
        #{player.crimeItem4Name, jdbcType=VARCHAR},
        #{player.crimeClue1Name, jdbcType=VARCHAR},
        #{player.crimeClue2Name, jdbcType=VARCHAR},
        #{player.crimeClue3Name, jdbcType=VARCHAR},
        #{player.crimeClue4Name, jdbcType=VARCHAR},
        #{player.crimeItem1PicUrl, jdbcType=VARCHAR},
        #{player.crimeItem2PicUrl, jdbcType=VARCHAR},
        #{player.crimeItem3PicUrl, jdbcType=VARCHAR},
        #{player.crimeItem4PicUrl, jdbcType=VARCHAR},
        #{player.crimeClue1PicUrl, jdbcType=VARCHAR},
        #{player.crimeClue2PicUrl, jdbcType=VARCHAR},
        #{player.crimeClue3PicUrl, jdbcType=VARCHAR},
        #{player.crimeClue4PicUrl, jdbcType=VARCHAR},
        #{player.remark, jdbcType=VARCHAR})
    </insert>

    <!--<select id="selectAvailablePos" resultMap="playerNumberVo">-->
    <!--select a.count, b.nums from (-->
    <!--SELECT count(*) as count FROM csi.tbl_current_player where game_no = #{gameNo} and status = 0 ) a-->
    <!--, ( select nums from tbl_current_game where game_no = #{gameNo} and status != 99 )  b-->
    <!--</select>-->
    <!--<resultMap id="playerNumberVo" type="com.csi.model.game.PlayerNumberVo" autoMapping="true"/>-->

    <select id="selectCount" resultType="int">
        SELECT count(*) as count FROM csi.tbl_current_player where game_no = #{gameNo} and status = 0
    </select>
    <!--<select id="numbers" resultType="int">-->
    <!--select nums from tbl_current_game where game_no = #{gameNo} and status != 99-->
    <!--</select>-->

    <select id="getGameByNo" resultMap="game">
        select id, game_no,game_type,create_user, nums, pos_of_crime_user, pos_of_crime_ass_user, pos_of_witness_user, status,remark
        from tbl_current_game where game_no = #{gameNo} and status != 99;
    </select>
    <resultMap id="game" type="com.csi.model.game.GameMysqlVo"/>


    <select id="selectItemClueUsed" resultMap="itemClueUsedList">
        select crime_item_1, crime_item_2, crime_item_3, crime_item_4,
                crime_clue_1, crime_clue_2, crime_clue_3, crime_clue_4
         from tbl_current_player WHERE game_no = #{gameNo} and status = 0;
    </select>
    <resultMap id="itemClueUsedList" type="com.csi.model.game.ItemClueUsedVo" autoMapping="true"/>


    <resultMap id="itemAll" type="com.csi.model.game.ItemClueVo" autoMapping="true"/>
    <select id="selectAllItem" resultMap="itemAll">
        select item_no as itemNo, item_name as itemName, pic as itemPicUrl
        from tbl_card_crime_item_clue where item_type = #{itemType} and status = 0;
    </select>


    <select id="selectCountInGame" resultType="int">
        select count(*) from tbl_current_player where status not in (99, 3) and user_no = #{userNo}
    </select>

    <resultMap id="gameVo" type="com.csi.model.game.GameVo" autoMapping="true"/>
    <select id="selectGameByNo" resultMap="gameVo">
        select * from v_game where gameNo = #{gameNo};
    </select>
    <select id="selectGameByUserNo" resultMap="gameVo">
        select * from v_game where gameNo = (select game_no from tbl_current_player where status != 99 and user_no = #{userNo});
    </select>

    <resultMap id="playerVo" type="com.csi.model.game.PlayerVo" autoMapping="true"/>
    <select id="lookAllPlayer" resultMap="playerVo">
        SELECT game_pos as gamePos,
       detect_crime_pos as detectiveCrimePos,
       detect_crime_item_pos as detectiveCrimeItemPos,
       detect_crime_clue_pos as detectiveCrimeCluePos,
       crime_item_1_name as crimeItem1Name,
       crime_item_2_name as crimeItem2Name,
       crime_item_3_name as crimeItem3Name,
       crime_item_4_name as crimeItem4Name,
       crime_clue_1_name as crimeClue1Name,
       crime_clue_2_name as crimeClue2Name,
       crime_clue_3_name as crimeClue3Name,
       crime_clue_4_name as crimeClue4Name
       FROM tbl_current_player
       where game_no = (select game_no from tbl_current_player where user_no = #{userNo})
    </select>

    <update id="playerExit">
        update tbl_current_player
        set status = #{playerStatus}
        where user_no = #{userNo}
    </update>
</mapper>
